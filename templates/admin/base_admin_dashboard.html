<!DOCTYPE html>
<html dir="ltr" lang="vi">

<head>
    {% load static %}
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Cổng thông tin nội bộ</title>
    <link rel="icon" type="image/png" sizes="16x16" href="{% static '' %}assets/images/favicon.png"/>
    <link href="{% static '' %}dist/css/style.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css"
          href="{% static '' %}assets/libs/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css"/>
    <link rel="stylesheet" type="text/css" href="{% static '' %}assets/libs/quill/dist/quill.snow.css"/>
    {% block css %}
    {% endblock %}
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="preloader">
    <div class="lds-ripple">
        <div class="lds-pos"></div>
        <div class="lds-pos"></div>
    </div>
</div>
<div id="main-wrapper" data-layout="vertical" data-navbarbg="skin5" data-sidebartype="full"
     data-sidebar-position="absolute" data-header-position="absolute" data-boxed-layout="full">
    <header class="topbar" data-navbarbg="skin5">
        <nav class="navbar top-navbar navbar-expand-md navbar-dark">
            <div class="navbar-header" data-logobg="skin5">
                <a class="navbar-brand" href="{% url 'admin_dashboard' %}">
                    <b class="logo-icon ps-2">
                        <img src="{% static '' %}assets/images/favicon.png" alt="homepage" class="light-logo"
                             width="25"/>
                    </b>
                    <span class="logo-text ms-2">
                            <img src="{% static '' %}assets/images/logo-text.png" alt="homepage" class="light-logo"/>
                        </span>
                </a>
                <a class="nav-toggler waves-effect waves-light d-block d-md-none" href="#">
                    <i class="ti-menu ti-close"></i>
                </a>
            </div>
            <div class="navbar-collapse collapse" id="navbarSupportedContent" data-navbarbg="skin5">
                <ul class="navbar-nav float-start me-auto">
                    <li class="nav-item d-none d-lg-block">
                            <span class="nav-link sidebartoggler waves-effect waves-light"
                                  Fdata-sidebartype="mini-sidebar">
                                <i class="mdi mdi-menu font-24"></i>
                            </span>
                    </li>
                </ul>
                <ul class="navbar-nav float-end">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-muted waves-effect waves-dark pro-pic" href="#"
                           id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="{% static '' %}assets/images/users/1.jpg" alt="user" class="rounded-circle"
                                 width="31"/>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end user-dd animated" aria-labelledby="navbarDropdown">
                            <li>
                                <a class="dropdown-item" href="{% url 'admin_profile' %}">
                                    <i class="mdi mdi-account me-1 ms-1"></i>Quản lý hồ sơ
                                </a>
                                <div class="dropdown-divider"></div>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'admin_change_password' %}">
                                    <i class="mdi mdi-settings me-1 ms-1"></i>Đổi mật khẩu
                                </a>
                                <div class="dropdown-divider"></div>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'logout' %}">
                                    <i class="fa fa-power-off me-1 ms-1"></i>Đăng xuất
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    <aside class="left-sidebar" data-sidebarbg="skin5">
        <div class="scroll-sidebar">
            <nav class="sidebar-nav">
                <ul id="sidebarnav" class="pt-4">
                    <li class="sidebar-item">
                        <a class="sidebar-link waves-effect waves-dark"
                           href="{% url 'admin_dashboard' %}" aria-expanded="false">
                            <i class="mdi mdi-home"></i>
                            <span class="hide-menu">Trang chủ</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link has-arrow waves-effect waves-dark"
                           aria-expanded="false">
                            <i class="mdi mdi-folder-account"></i>
                            <span class="hide-menu">Quản lý</span>
                        </a>
                        <ul aria-expanded="false" class="collapse first-level">
                            <li class="sidebar-item">
                                <a href="{% url 'admin_lecturer_management' %}" class="sidebar-link">
                                    <i class="mdi mdi-account-edit"></i>
                                    <span class="hide-menu"> Giảng viên </span>
                                </a>
                            </li>
                            <li class="sidebar-item">
                                <a href="{% url 'admin_student_management' %}" class="sidebar-link">
                                    <i class="mdi mdi-account-edit"></i>
                                    <span class="hide-menu"> Sinh viên </span>
                                </a>
                            </li>
                            <li class="sidebar-item">
                                <a href="{% url 'admin_profile' %}" class="sidebar-link">
                                    <i class="mdi mdi-account-edit"></i>
                                    <span class="hide-menu"> Nhân viên </span>
                                </a>
                            </li>
                            <li class="sidebar-item">
                                <a href="{% url 'admin_schedule_management' %}" class="sidebar-link">
                                    <i class="mdi mdi-account-edit"></i>
                                    <span class="hide-menu"> Thời khóa biểu </span>
                                </a>
                            </li>
                            <li class="sidebar-item">
                                <a href="{% url 'admin_change_password' %}" class="sidebar-link">
                                    <i class="mdi mdi-account-edit"></i>
                                    <span class="hide-menu"> Admin </span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link waves-effect waves-dark sidebar-link"
                           href="#" aria-expanded="false">
                            <i class="mdi mdi-folder"></i>
                            <span class="hide-menu">Quản lý lớp học</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>
    <div class="page-wrapper">
        <div class="container-fluid">
            {% block content %}
            {% endblock %}
        </div>
        <footer class="footer text-center">
            Attendance system was built and developed by HUTECH students
        </footer>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{% static '' %}assets/libs/jquery/dist/jquery.min.js"></script>
<script src="{% static '' %}assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static '' %}assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js"></script>
<script src="{% static '' %}assets/extra-libs/sparkline/sparkline.js"></script>
<script src="{% static '' %}dist/js/waves.js"></script>
<script src="{% static '' %}dist/js/sidebarmenu.js"></script>
<script src="{% static '' %}dist/js/custom.min.js"></script>
<script src="{% static '' %}assets/extra-libs/multicheck/datatable-checkbox-init.js"></script>
<script src="{% static '' %}assets/extra-libs/multicheck/jquery.multicheck.js"></script>
<script src="{% static '' %}assets/extra-libs/DataTables/datatables.min.js"></script>
<script src="{% static '' %}assets/libs/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
<script src="{% static '' %}assets/js/manage-student.js"></script>
<script>
    jQuery("#birthday").datepicker({
        autoclose: true,
        todayHighlight: true,
    });
</script>
<script>
    function confirmDeleteStudent(studentId) {
        var deleteUrl = "{% url 'admin_student_delete' '1' %}".replace('1', studentId);
        $('#confirmDeleteButton').attr('href', deleteUrl);
        $('#confirmDeleteModal').modal('show');
        $('#studentIdToDelete').text(studentId);
    }

    function editStudent(studentId) {
        var id_student = studentId
        var editForm = $('#editStudentForm');
        editForm.attr('action', "{% url 'admin_student_edit' 0 %}".replace('0', studentId));

        $.ajax({
                type: "GET",
                url: "{% url 'admin_student_get_info' '1' %}".replace('1', id_student),
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    $('#id_student').val(data.student.id_student);
                    $('#student_name').val(data.student.student_name);
                    $('#email').val(data.student.email);
                    $('#phone').val(data.student.phone);
                    $('#address').val(data.student.address);
                    $('#birthday').val(data.student.birthday);
                    $('#PathImageFolder').val(data.student.PathImageFolder);
                    $('#editStudentModal').modal('show');
                },
            }
        )
    }

    function editLecturer(staffId) {
        var id_staff = staffId
        $.ajax({
                type: "GET",
                url: "{% url 'admin_lecturer_get_info' '1' %}".replace('1', id_staff),
                dataType: "json",
                success: function (data1) {
                    console.log(data1);
                    $('#id_staff').val(data1.id_staff);
                    $('#staff_name').val(data1.staff_name);
                    $('#email').val(data1.email);
                    $('#phone').val(data1.phone);
                    $('#address').val(data1.address);
                    $('#birthday').val(data1.birthday);

                },
            }
        )
    }
</script>
<script>
    let isChecking = false;
    let intervalId;
    document.getElementById("addStudentButton").addEventListener("click", function () {
        // Get the student ID from the input with the ID "id_student"
        var studentId = document.getElementById("id_student").value;
        const videoElement = document.getElementById('video-feed');
        const idStudentField = document.getElementById("id_student");
        const studentNameField = document.getElementById("student_name");
        const emailField = document.getElementById("email");
        const phoneField = document.getElementById("phone");
        const addressField = document.getElementById("address");
        const birthdayField = document.getElementById("birthday");
        const pathImageFolderField = document.getElementById("PathImageFolder");

        if (
            idStudentField.value === "" ||
            studentNameField.value === "" ||
            emailField.value === "" ||
            phoneField.value === "" ||
            addressField.value === "" ||
            birthdayField.value === "" ||
            pathImageFolderField.value === ""
        ) {
            alert("Vui lòng điền đầy đủ thông tin.");
            event.preventDefault(); // Ngăn chặn việc gửi form nếu dữ liệu không hợp lệ
        } else {
            videoElement.src = "/admin/student-management/live_video_feed/" + studentId;
            if (isChecking) {
                // Nếu đang kiểm tra, dừng kiểm tra
                clearInterval(intervalId);
                isChecking = false;
                console.log("Dừng kiểm tra");
            } else {
                intervalId = setInterval(() => {
                    fetch("/admin/student-management/check_capture_status/")  // Thay đổi thành URL chính xác
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);

                            if (data.capture_status == 1) {
                                alert("Thành công");
                                const form = document.getElementById("addStudentForm");
                                form.submit();
                                clearInterval(intervalId);  // Dừng kiểm tra
                                isChecking = false;
                            }
                        })
                        .catch(error => {
                            console.error("Lỗi:", error);
                        });
                }, 1000);
                isChecking = true;
                console.log("Bắt đầu kiểm tra");
            }
        }
    });

    const idStudentField = document.getElementById("id_student");
    const pathImageFolderField = document.getElementById("PathImageFolder");
    // Thêm sự kiện onchange vào trường id_student
    idStudentField.addEventListener("change", function () {
        const studentId = idStudentField.value;
        pathImageFolderField.value = "./main/Dataset/FaceData/processed/" + studentId;
    });
</script>
<script>
    document.getElementById('train-button').addEventListener('click', function () {
        let timerInterval
        Swal.fire({
            title: 'Thông báo!',
            html: 'Quá trình training đang được diễn ra, vui lòng đợi !!!!',
            timer: 20000,
            timerProgressBar: true,
            didOpen: () => {
                Swal.showLoading()
                const b = Swal.getHtmlContainer().querySelector('b')
                timerInterval = setInterval(() => {
                }, 100)
            },
            willClose: () => {
                clearInterval(timerInterval)
            }
        }).then((result) => {
            /* Read more about handling dismissals below */
            if (result.dismiss === Swal.DismissReason.timer) {
                console.log('I was closed by the timer')
            }
        })
        fetch('/admin/student-management/train')
            .then(response => response.json())
            .then(data => {
                Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: data.resuil,
                    showConfirmButton: false,
                    timer: 3000
                });

                // Làm mới trang sau khi thành công
                setTimeout(function () {
                    location.reload();
                }, 2000);
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Có lỗi xảy ra trong quá trình thực hiện yêu cầu.'
                });
                console.error('Fetch Error:', error);
            });
    });
</script>
<script>
    $("#addSchedule").click(function (e) {
        e.preventDefault();
        $('#addNewScheduleModal').modal('show')
    });

    $("#editSchedule").click(function (e) {
        e.preventDefault();
        $('#editScheduleModal').modal('show')
    });

    $("#deleteSchedule").click(function (e) {
        e.preventDefault();
    });
</script>
<script>
    function confirmDelete(classroomId) {
        var deleteUrl = "{% url 'admin_schedule_delete' '1' %}".replace('1', classroomId);
        $('#confirmDeleteButton').attr('href', deleteUrl);
        $('#confirmDeleteModal').modal('show');
        $('#classroomIdToDelete').text(classroomId);
    }

    function editSchedule(classroomId) {
        var id_classroom = classroomId
        $.ajax({
                type: "GET",
                url: "{% url 'admin_schedule_get_info' '1' %}".replace('1', id_classroom),
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    $('#id_classroom').val(data.id_classroom);
                    $('#name').val(data.name);
                    $('#begin_date').val(data.begin_date);
                    $('#end_date').val(data.end_date);
                    $('#day_of_week_begin').val(data.day_of_week_begin);
                    $('#begin_time').val(data.begin_time);
                    $('#end_time').val(data.end_time);
                    $('#id_lecturer').val(data.id_lecturer);
                    $('#editScheduleModal').modal('show');
                },
            }
        )
    }
</script>
<script>
    document.getElementById("addScheduleButton").addEventListener("click", function () {

        var id_classroom = document.getElementById("id_classroom").value;
        var name = document.getElementById("name").value;
        var begin_date = document.getElementById("begin_date").value;
        var end_date = document.getElementById("end_date").value;
        var day_of_week_begin = document.getElementById("day_of_week_begin").value;
        var begin_time = document.getElementById("begin_time").value;
        var end_time = document.getElementById("end_time").value;
        var id_lecturer = document.getElementById("id_lecturer").value;


        var data = {
            'id_classroom': id_classroom,
            'name': name,
            'begin_date': begin_date,
            'end_date': end_date,
            'day_of_week_begin': day_of_week_begin,
            'begin_time': begin_time,
            'end_time': end_time,
            'id_lecturer': id_lecturer,
        };

        $.ajax({
            url: '{% url 'admin_schedule_add' %}',
            type: 'POST',
            data: data,
            success: function (response) {
                alert('Thêm Thời Khóa Biểu thành công.');
            },
            error: function (xhr, textStatus, errorThrown) {
                alert('Đã xảy ra lỗi: ' + errorThrown);
            }
        });
    });
</script>
</body>

</html>